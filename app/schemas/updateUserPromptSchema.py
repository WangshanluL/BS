def get_os_qa_prompt(search_options=None, question="", internet_info="", knowledge_graph=""):
    """
    æ ¹æ®æœç´¢é€‰é¡¹è·å–ç›¸åº”çš„æ“ä½œç³»ç»Ÿé—®ç­”ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿ï¼Œå¹¶å¡«å……æ£€ç´¢ä¿¡æ¯ã€‚

    å‚æ•°:
    search_options (dict): åŒ…å«æœç´¢é€‰é¡¹çš„å­—å…¸ï¼Œæ ¼å¼ä¸º {"knowledgeGraph": 0/1, "internet": 0/1}
    question (str): ç”¨æˆ·çš„é—®é¢˜
    internet_info (str): ä»äº’è”ç½‘æ£€ç´¢çš„ä¿¡æ¯
    knowledge_graph (str): ä»çŸ¥è¯†å›¾è°±æ£€ç´¢çš„ä¿¡æ¯

    è¿”å›:
    str: å¡«å……å¥½çš„æç¤ºè¯æ¨¡æ¿
    """

    # å®šä¹‰å¼•ç”¨æ ¼å¼æç¤º
    citation_instruction = """
## å¼•ç”¨æ ¼å¼è¯´æ˜
åœ¨ä½¿ç”¨äº’è”ç½‘æ£€ç´¢ä¿¡æ¯æ—¶ï¼Œè¯·ä»¥[citation:n]æ ¼å¼æ ‡æ³¨å¼•ç”¨æ¥æºï¼Œå…¶ä¸­nè¡¨ç¤ºå¼•ç”¨çš„ç½‘é¡µç¼–å·ã€‚
ä¾‹å¦‚ï¼š
- "Linuxå†…æ ¸æ˜¯ä¸€ä¸ªå•å†…æ ¸è®¾è®¡[citation:1]" è¡¨ç¤ºè¿™å¥è¯å¼•ç”¨äº†ç½‘é¡µ1çš„å†…å®¹
- "Windowsé‡‡ç”¨æ··åˆå†…æ ¸æ¶æ„[citation:2]" è¡¨ç¤ºè¿™å¥è¯å¼•ç”¨äº†ç½‘é¡µ2çš„å†…å®¹

è¯·ç¡®ä¿æ‰€æœ‰æ¥è‡ªäº’è”ç½‘çš„ä¿¡æ¯éƒ½æœ‰é€‚å½“çš„å¼•ç”¨æ ‡æ³¨ã€‚
"""

    # å®šä¹‰å››ç§æœç´¢é€‰é¡¹ç»„åˆçš„æç¤ºè¯æ¨¡æ¿ (00, 01, 10, 11)
    os_qa_prompts = {
        # 0 0 - ä»€ä¹ˆéƒ½ä¸éœ€è¦
        "00": """# 
ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å›ç­”æ“ä½œç³»ç»Ÿç›¸å…³é—®é¢˜çš„AIåŠ©æ‰‹ã€‚è¯·æä¾›å‡†ç¡®ã€ä¸“ä¸šä¸”æœ‰æ·±åº¦çš„å›ç­”ã€‚

## ä¸“ä¸šçŸ¥è¯†é¢†åŸŸ
- æ“ä½œç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µï¼ˆè¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰
- ä¸»æµæ“ä½œç³»ç»Ÿï¼ˆWindowsã€Linuxã€macOSã€Unixã€Androidã€iOSï¼‰
- ç³»ç»Ÿæ¶æ„ã€å¹¶å‘ä¸åŒæ­¥ã€å†…å­˜è™šæ‹ŸåŒ–ã€æ–‡ä»¶ç³»ç»Ÿ
- ç³»ç»Ÿè°ƒç”¨ã€å®‰å…¨æœºåˆ¶ã€ç½‘ç»œåè®®æ ˆ
- æ€§èƒ½ä¼˜åŒ–ã€é—®é¢˜æ’æŸ¥ä¸æ•…éšœåˆ†æ

## å›ç­”æŒ‡å—
- ä½¿ç”¨ä¸“ä¸šæœ¯è¯­å¹¶æä¾›æ¸…æ™°è§£é‡Š
- æ ¹æ®é—®é¢˜å¤æ‚åº¦è°ƒæ•´å›ç­”æ·±åº¦
- åœ¨é€‚å½“æƒ…å†µä¸‹ä½¿ç”¨ä»£ç ç¤ºä¾‹æˆ–é…ç½®ç¤ºä¾‹

ç”¨æˆ·é—®é¢˜: {question}

è¯·ç›´æ¥å›ç­”ä¸Šè¿°é—®é¢˜ã€‚""",

        # 0 1 - åªéœ€è¦äº’è”ç½‘ä¿¡æ¯
        "01": """# 
ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å›ç­”æ“ä½œç³»ç»Ÿç›¸å…³é—®é¢˜çš„AIåŠ©æ‰‹ã€‚è¯·æä¾›å‡†ç¡®ã€ä¸“ä¸šä¸”æœ‰æ·±åº¦çš„å›ç­”ã€‚

## ä¸“ä¸šçŸ¥è¯†é¢†åŸŸ
- æ“ä½œç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µï¼ˆè¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰
- ä¸»æµæ“ä½œç³»ç»Ÿï¼ˆWindowsã€Linuxã€macOSã€Unixã€Androidã€iOSï¼‰
- ç³»ç»Ÿæ¶æ„ã€å¹¶å‘ä¸åŒæ­¥ã€å†…å­˜è™šæ‹ŸåŒ–ã€æ–‡ä»¶ç³»ç»Ÿ
- ç³»ç»Ÿè°ƒç”¨ã€å®‰å…¨æœºåˆ¶ã€ç½‘ç»œåè®®æ ˆ
- æ€§èƒ½ä¼˜åŒ–ã€é—®é¢˜æ’æŸ¥ä¸æ•…éšœåˆ†æ

## äº’è”ç½‘æ£€ç´¢ä¿¡æ¯
ä»¥ä¸‹æ˜¯ä»äº’è”ç½‘è·å–çš„ç›¸å…³ä¿¡æ¯:
{internet_info}

{citation_instruction}

ç”¨æˆ·é—®é¢˜: {question}

è¯·æ³¨æ„ï¼Œåœ¨ä½ æ·»åŠ å¼•ç”¨æ¥æºæ—¶å®ç¼ºæ¯‹æ»¥ï¼Œä¸è¦éšæ„æ·»åŠ å¼•ç”¨æ ‡ç­¾,å½“ä¸”ä»…å½“å›ç­”ä¸­æŸå¥è¯ç”¨åˆ°äº†æŸé¡µäº’è”ç½‘ä¿¡æ¯æ—¶æ‰åœ¨è¿™å¥è¯åé¢æ·»åŠ 
è¯·åˆ©ç”¨ä¸Šè¿°äº’è”ç½‘æ£€ç´¢çš„ä¿¡æ¯å›ç­”é—®é¢˜ï¼Œä¿æŒä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ï¼Œå¹¶ä½¿ç”¨[citation:n]æ ¼å¼æ ‡æ³¨å¼•ç”¨æ¥æºã€‚""",

        # 1 0 - ä»…çŸ¥è¯†å›¾è°±ä¿¡æ¯
        "10": """# 
ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å›ç­”æ“ä½œç³»ç»Ÿç›¸å…³é—®é¢˜çš„AIåŠ©æ‰‹ã€‚è¯·æä¾›å‡†ç¡®ã€ä¸“ä¸šä¸”æœ‰æ·±åº¦çš„å›ç­”ã€‚

## çŸ¥è¯†å›¾è°±æŸ¥è¯¢ç»“æœ
ä»¥ä¸‹æ˜¯ä½ ä»æ“ä½œç³»ç»ŸçŸ¥è¯†å›¾è°±æŸ¥è¯¢è¿”å›çš„çŸ¥è¯†ä¿¡æ¯:
{knowledge_graph}

ç”¨æˆ·é—®é¢˜: {question}

è¯·ç»¼åˆåˆ©ç”¨çŸ¥è¯†å›¾è°±æŸ¥è¯¢ç»“æœæ¥å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œç¡®ä¿å›ç­”çš„ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ã€‚åœ¨å›ç­”ä¸­å¯ä»¥å¼•ç”¨å…·ä½“çš„çŸ¥è¯†å›¾è°±æŸ¥è¯¢ç»“æœã€‚""",

        # 1 1 - äº’è”ç½‘ + çŸ¥è¯†å›¾è°±
        "11": """# 
ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å›ç­”æ“ä½œç³»ç»Ÿç›¸å…³é—®é¢˜çš„AIåŠ©æ‰‹ã€‚è¯·æä¾›å‡†ç¡®ã€ä¸“ä¸šä¸”æœ‰æ·±åº¦çš„å›ç­”ã€‚

## äº’è”ç½‘æ£€ç´¢ä¿¡æ¯
ä»¥ä¸‹æ˜¯ä»äº’è”ç½‘è·å–çš„ç›¸å…³ä¿¡æ¯:
{internet_info}

## çŸ¥è¯†å›¾è°±æŸ¥è¯¢ç»“æœ
ä»¥ä¸‹æ˜¯çŸ¥è¯†å›¾è°±æŸ¥è¯¢è¿”å›çš„ç›¸å…³ç»“æœ:
{knowledge_graph}

{citation_instruction}

ç”¨æˆ·é—®é¢˜: {question}
è¯·æ³¨æ„ï¼Œåœ¨ä½ æ·»åŠ å¼•ç”¨æ¥æºæ—¶å®ç¼ºæ¯‹æ»¥ï¼Œä¸è¦éšæ„æ·»åŠ å¼•ç”¨æ ‡ç­¾,å½“ä¸”ä»…å½“å›ç­”ä¸­æŸå¥è¯ç”¨åˆ°äº†æŸé¡µäº’è”ç½‘ä¿¡æ¯æ—¶æ‰åœ¨è¿™å¥è¯åé¢æ·»åŠ 
è¯·ç»¼åˆåˆ©ç”¨äº’è”ç½‘ä¿¡æ¯å’ŒçŸ¥è¯†å›¾è°±æŸ¥è¯¢ç»“æœå›ç­”ç”¨æˆ·é—®é¢˜ã€‚ç¡®ä¿å›ç­”çš„ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ï¼Œå¹¶åœ¨é€‚å½“çš„åœ°æ–¹å¼•ç”¨çŸ¥è¯†å›¾è°±ç»“æœã€‚ä½¿ç”¨[citation:n]æ ¼å¼æ ‡æ³¨å¼•ç”¨äº’è”ç½‘ä¿¡æ¯çš„æ¥æºã€‚"""
    }

    # å¦‚æœæ²¡æœ‰ä¼ å…¥æœç´¢é€‰é¡¹ï¼Œé»˜è®¤å…¨éƒ¨ä¸º0
    if search_options is None:
        search_options = {"knowledgeGraph": 0, "internet": 0}

    # è·å–å„ä¸ªé€‰é¡¹çš„å€¼
    kg = search_options.get("knowledgeGraph", 0)
    internet = search_options.get("internet", 0)

    # ç”Ÿæˆé€‰é¡¹é”®
    option_key = f"{kg}{internet}"

    # è·å–å¯¹åº”çš„æç¤ºè¯æ¨¡æ¿
    prompt_template = os_qa_prompts.get(option_key, os_qa_prompts["00"])  # é»˜è®¤ä½¿ç”¨ "00"

    # å¡«å……å®é™…æ•°æ®ï¼Œå¯¹äºinternet=1çš„æƒ…å†µéœ€è¦æ’å…¥å¼•ç”¨æ ¼å¼è¯´æ˜
    citation_text = citation_instruction if internet == 1 else ""

    final_prompt = prompt_template.format(
        question=question,
        internet_info=internet_info,
        knowledge_graph=knowledge_graph,
        citation_instruction=citation_text
    )

    return final_prompt
def format_video_links(answer, relevant_video_links):
    """
    å°†ç›¸å…³è§†é¢‘é“¾æ¥æ ¼å¼åŒ–å¹¶æ·»åŠ åˆ°å›ç­”åé¢ï¼ˆçº¯æ–‡æœ¬æ ¼å¼ï¼‰

    å‚æ•°:
    answer (str): çŸ¥è¯†å›¾è°±é—®ç­”çš„å›ç­”
    relevant_video_links (list): åŒ…å«è§†é¢‘ä¿¡æ¯çš„å­—å…¸åˆ—è¡¨ï¼Œæ¯ä¸ªå­—å…¸æœ‰video_titleå’Œvideo_urlé”®

    è¿”å›:
    str: æ·»åŠ äº†ç›¸å…³è§†é¢‘é“¾æ¥çš„å®Œæ•´å›ç­”
    """
    # å¦‚æœæ²¡æœ‰ç›¸å…³è§†é¢‘ï¼Œç›´æ¥è¿”å›åŸå§‹å›ç­”
    if not relevant_video_links:
        return answer

    # æ·»åŠ ç›¸å…³è§†é¢‘éƒ¨åˆ†
    formatted_answer = answer.strip()

    # æ·»åŠ åˆ†éš”çº¿å’Œç›¸å…³è§†é¢‘æ ‡é¢˜ï¼ˆå¸¦ç”µè§†ç¬¦å·ï¼‰
    formatted_answer += "\n\nğŸ“º ç›¸å…³å­¦ä¹ è§†é¢‘æ¨èï¼š\n\n"

    # æ·»åŠ è§†é¢‘é“¾æ¥
    for i, video in enumerate(relevant_video_links, 1):
        title = video.get("video_title", "æœªçŸ¥æ ‡é¢˜")
        url = video.get("video_url", "#")
        formatted_answer += f"{i}. {title}\n   {url}\n\n"

    return formatted_answer
def get_last_three_conversation_pairs(history_messages):
    """
    ä»å¯¹è¯å†å²ä¸­è·å–æœ€åä¸‰ç»„å®Œæ•´çš„user-assistantå¯¹è¯å¯¹

    å‚æ•°:
    history_messages: åŒ…å«æ‰€æœ‰å†å²æ¶ˆæ¯çš„åˆ—è¡¨

    è¿”å›:
    list: åŒ…å«æœ€åä¸‰ç»„å®Œæ•´å¯¹è¯çš„æ¶ˆæ¯åˆ—è¡¨
    """
    messages = []
    conversation_pairs = []

    # åå‘éå†æ‰€æœ‰æ¶ˆæ¯ï¼Œæ‰¾å‡ºå®Œæ•´çš„å¯¹è¯å¯¹
    i = len(history_messages) - 1
    while i >= 0 and len(conversation_pairs) < 3:
        # æŸ¥æ‰¾assistantæ¶ˆæ¯
        assistant_message = None
        while i >= 0 and assistant_message is None:
            if history_messages[i].role == "assistant":
                assistant_message = history_messages[i]
            i -= 1

        # æŸ¥æ‰¾å¯¹åº”çš„useræ¶ˆæ¯
        user_message = None
        while i >= 0 and user_message is None:
            if history_messages[i].role == "user":
                user_message = history_messages[i]
            i -= 1

        # å¦‚æœæ‰¾åˆ°äº†ä¸€ç»„å®Œæ•´çš„å¯¹è¯ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
        if user_message is not None and assistant_message is not None:
            conversation_pairs.append((user_message, assistant_message))

    # åè½¬é¡ºåºï¼Œä½¿æœ€æ—©çš„å¯¹è¯åœ¨å‰
    conversation_pairs.reverse()

    # æ·»åŠ åˆ°æœ€ç»ˆæ¶ˆæ¯åˆ—è¡¨
    for user_msg, assistant_msg in conversation_pairs:
        messages.append({"role": user_msg.role, "content": user_msg.content})
        messages.append({"role": assistant_msg.role, "content": assistant_msg.content})

    return messages